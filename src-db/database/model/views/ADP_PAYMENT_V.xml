<?xml version="1.0"?>
  <database name="VIEW ADP_PAYMENT_V">
    <view name="ADP_PAYMENT_V"><![CDATA[SELECT p.fin_payment_schedule_id AS adp_payment_v_id, i.em_adp_budget_id AS adp_budget_id, p.fin_payment_schedule_id, p.ad_client_id, p.ad_org_id, p.created, p.createdby, p.updated, p.updatedby, p.c_invoice_id, p.c_order_id, i.dateinvoiced AS fechafactura, p.duedate, p.fin_paymentmethod_id, p.c_currency_id, p.amount, p.paidamt, p.outstandingamt, p.isactive, ccu.iso_code(3) AS budgetcurrency, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN 0 ELSE (SELECT cc.multiplyrate FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1) END AS cambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN NULL ELSE (SELECT cc.validto FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1) END AS fechacambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN p.amount ELSE p.amount * ((SELECT cc.multiplyrate FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1)) END AS amountcambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN NULL ELSE (SELECT cc.validto FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.ad_client_id = p.ad_client_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.validto <= ((SELECT fin_payment_detail_v.paymentdate FROM fin_payment_detail_v WHERE fin_payment_detail_v.fin_payment_sched_ord_v_id = p.fin_payment_schedule_id ORDER BY fin_payment_detail_v.updated DESC LIMIT 1)) ORDER BY cc.validto DESC LIMIT 1) END AS fechacambiopago, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN p.paidamt ELSE p.paidamt * ((SELECT COALESCE(cc.multiplyrate, 0) AS "coalesce" FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.ad_client_id = p.ad_client_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.validto <= ((SELECT fin_payment_detail_v.paymentdate FROM fin_payment_detail_v WHERE fin_payment_detail_v.fin_payment_sched_ord_v_id = p.fin_payment_schedule_id ORDER BY fin_payment_detail_v.updated DESC LIMIT 1)) ORDER BY cc.validto DESC LIMIT 1)) END AS paidamtcambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN 0 ELSE p.outstandingamt * ((SELECT cc.multiplyrate FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.validto <= i.dateinvoiced AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1)) END AS outstandingamtcambio, p.fin_payment_priority_id, p.update_payment_plan, p.origduedate, p.description, p.expecteddate FROM c_invoice i LEFT JOIN fin_payment_schedule p ON i.c_invoice_id = p.c_invoice_id LEFT JOIN adp_budget apm ON apm.adp_budget_id = i.em_adp_budget_id LEFT JOIN c_project cp ON cp.c_project_id = apm.c_project_id LEFT JOIN c_currency ccu ON ccu.c_currency_id = cp.c_currency_id WHERE i.em_adp_budget_id IS NOT NULL UNION SELECT p.fin_payment_schedule_id AS adp_payment_v_id, o.em_adp_budget_id AS adp_budget_id, p.fin_payment_schedule_id, p.ad_client_id, p.ad_org_id, p.created, p.createdby, p.updated, p.updatedby, p.c_invoice_id, p.c_order_id, o.dateordered AS fechafactura, p.duedate, p.fin_paymentmethod_id, p.c_currency_id, p.amount, p.paidamt, p.outstandingamt, p.isactive, ccu.iso_code(3) AS budgetcurrency, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN 0 ELSE (SELECT cc.multiplyrate FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1) END AS cambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN NULL ELSE (SELECT cc.validto FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1) END AS fechacambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN p.amount ELSE p.amount * ((SELECT cc.multiplyrate FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.ad_client_id = p.ad_client_id ORDER BY cc.validto DESC LIMIT 1)) END AS amountcambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN NULL ELSE (SELECT cc.validto FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.ad_client_id = p.ad_client_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.validto <= ((SELECT fin_payment_detail_v.paymentdate FROM fin_payment_detail_v WHERE fin_payment_detail_v.fin_payment_sched_ord_v_id = p.fin_payment_schedule_id ORDER BY fin_payment_detail_v.updated DESC LIMIT 1)) ORDER BY cc.validto DESC LIMIT 1) END AS fechacambiopago, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN p.paidamt ELSE p.paidamt * ((SELECT COALESCE(cc.multiplyrate, 0) AS "coalesce" FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.ad_client_id = p.ad_client_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.validto <= ((SELECT fin_payment_detail_v.paymentdate FROM fin_payment_detail_v WHERE fin_payment_detail_v.fin_payment_sched_ord_v_id = p.fin_payment_schedule_id ORDER BY fin_payment_detail_v.updated DESC LIMIT 1)) ORDER BY cc.validto DESC LIMIT 1)) END AS paidamtcambio, CASE WHEN p.c_currency_id = ccu.c_currency_id THEN 0 ELSE p.outstandingamt * ((SELECT cc.multiplyrate FROM c_conversion_rate cc WHERE cc.c_currency_id = p.c_currency_id AND cc.ad_client_id = p.ad_client_id AND cc.c_currency_id_to = cp.c_currency_id AND cc.validto <= o.dateordered ORDER BY cc.validto DESC LIMIT 1)) END AS outstandingamtcambio, p.fin_payment_priority_id, p.update_payment_plan, p.origduedate, p.description, p.expecteddate FROM c_order o LEFT JOIN fin_payment_schedule p ON o.c_order_id = p.c_order_id LEFT JOIN adp_budget apm ON apm.adp_budget_id = o.em_adp_budget_id LEFT JOIN c_project cp ON cp.c_project_id = apm.c_project_id LEFT JOIN c_currency ccu ON ccu.c_currency_id = cp.c_currency_id WHERE o.em_adp_budget_id IS NOT NULL]]></view>
  </database>
